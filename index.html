import React, { useState, useEffect } from 'react';
import { User, Clock, Heart, Star, Trophy, MessageCircle } from 'lucide-react';

const PersonalityGame = () => {
  const [gameState, setGameState] = useState('avatar-creation');
  const [avatar, setAvatar] = useState({
    name: '',
    appearance: { hair: 'brown', skin: 'medium', style: 'casual' },
    background: ''
  });
  
  const [behaviorData, setBehaviorData] = useState({
    introversion: 0, // -5 to +5 scale
    riskTolerance: 0,
    empathy: 0,
    problemSolving: 0, // analytical vs creative
    cooperation: 0,
    timeSpent: {},
    choices: []
  });

  const [currentScenario, setCurrentScenario] = useState(0);
  const [inventory, setInventory] = useState([]);
  const [relationships, setRelationships] = useState({
    alex: 0, // friendly NPC
    sam: 0,  // demanding NPC
    riley: 0 // shy NPC
  });

  const trackBehavior = (category, value, choice = null) => {
    setBehaviorData(prev => ({
      ...prev,
      [category]: Math.max(-5, Math.min(5, prev[category] + value)),
      choices: choice ? [...prev.choices, { scenario: currentScenario, choice, timestamp: Date.now() }] : prev.choices
    }));
  };

  const scenarios = [
    {
      id: 'village_arrival',
      title: 'Welcome to Harmonia Village',
      description: 'You arrive in a bustling village square. People are going about their daily business.',
      options: [
        { text: 'Approach the friendly-looking person by the fountain', action: () => trackBehavior('introversion', 2, 'social_approach') },
        { text: 'Explore the shops and stalls quietly', action: () => trackBehavior('introversion', -1, 'quiet_exploration') },
        { text: 'Find the village notice board to read announcements', action: () => trackBehavior('problemSolving', 1, 'information_gathering') }
      ]
    },
    {
      id: 'first_task',
      title: 'The Missing Cat',
      description: 'Alex approaches you: "My cat Whiskers is missing! I\'ve looked everywhere. Could you help me find her?"',
      options: [
        { text: 'Of course! Let\'s search together right away', action: () => { trackBehavior('empathy', 2, 'immediate_help'); trackBehavior('cooperation', 1); } },
        { text: 'I\'ll help, but let me think of a systematic search plan first', action: () => { trackBehavior('problemSolving', 2, 'systematic_approach'); trackBehavior('empathy', 1); } },
        { text: 'Sorry, I have my own things to focus on right now', action: () => { trackBehavior('empathy', -2, 'self_focused'); trackBehavior('cooperation', -1); } }
      ]
    },
    {
      id: 'resource_dilemma',
      title: 'Limited Resources',
      description: 'You find a valuable gem while searching. Sam appears and demands: "That\'s mine! I dropped it earlier!"',
      options: [
        { text: 'Give Sam the gem without question', action: () => { trackBehavior('cooperation', 2, 'immediate_give'); trackBehavior('riskTolerance', -1); } },
        { text: 'Ask Sam to prove it\'s theirs before deciding', action: () => { trackBehavior('problemSolving', 1, 'verification_seek'); trackBehavior('riskTolerance', 1); } },
        { text: 'Keep the gem - finders keepers', action: () => { trackBehavior('cooperation', -2, 'keep_item'); trackBehavior('riskTolerance', 2); } }
      ]
    },
    {
      id: 'leadership_moment',
      title: 'Group Challenge',
      description: 'Riley quietly mentions there\'s a bridge that needs repair for everyone to reach the market safely.',
      options: [
        { text: 'Organize a group effort to fix it together', action: () => { trackBehavior('cooperation', 2, 'organize_group'); trackBehavior('introversion', 1); } },
        { text: 'Offer to fix it yourself to avoid bothering others', action: () => { trackBehavior('introversion', -1, 'solo_work'); trackBehavior('empathy', 1); } },
        { text: 'Suggest everyone finds their own way around', action: () => { trackBehavior('cooperation', -1, 'individualistic'); trackBehavior('problemSolving', 1); } }
      ]
    }
  ];

  const renderAvatarCreation = () => (
    <div className="max-w-2xl mx-auto p-6 bg-white rounded-lg shadow-lg">
      <h2 className="text-2xl font-bold mb-6 text-center">Create Your Character</h2>
      
      <div className="space-y-6">
        <div>
          <label className="block text-sm font-medium mb-2">Character Name</label>
          <input
            type="text"
            value={avatar.name}
            onChange={(e) => setAvatar(prev => ({ ...prev, name: e.target.value }))}
            className="w-full p-3 border rounded-lg"
            placeholder="Enter your character's name"
          />
        </div>
        
        <div>
          <label className="block text-sm font-medium mb-2">Hair Color</label>
          <div className="flex gap-2">
            {['brown', 'black', 'blonde', 'red'].map(color => (
              <button
                key={color}
                onClick={() => setAvatar(prev => ({ ...prev, appearance: { ...prev.appearance, hair: color } }))}
                className={`px-4 py-2 rounded ${avatar.appearance.hair === color ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
              >
                {color}
              </button>
            ))}
          </div>
        </div>
        
        <div>
          <label className="block text-sm font-medium mb-2">Background</label>
          <div className="space-y-2">
            {[
              { value: 'scholar', label: 'Scholar - You love learning and books', behavior: () => trackBehavior('problemSolving', 1) },
              { value: 'traveler', label: 'Traveler - You enjoy meeting new people', behavior: () => trackBehavior('introversion', 1) },
              { value: 'craftsperson', label: 'Craftsperson - You prefer working with your hands', behavior: () => trackBehavior('problemSolving', -1) }
            ].map(bg => (
              <button
                key={bg.value}
                onClick={() => {
                  setAvatar(prev => ({ ...prev, background: bg.value }));
                  bg.behavior();
                }}
                className={`w-full p-3 text-left rounded border ${avatar.background === bg.value ? 'bg-blue-100 border-blue-500' : 'border-gray-300'}`}
              >
                {bg.label}
              </button>
            ))}
          </div>
        </div>
        
        {avatar.name && avatar.background && (
          <button
            onClick={() => setGameState('game')}
            className="w-full bg-green-500 text-white py-3 rounded-lg font-medium hover:bg-green-600"
          >
            Begin Your Journey
          </button>
        )}
      </div>
    </div>
  );

  const renderGame = () => {
    const scenario = scenarios[currentScenario];
    
    return (
      <div className="max-w-4xl mx-auto p-6">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Main Game Area */}
          <div className="lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
            <h2 className="text-2xl font-bold mb-4">{scenario.title}</h2>
            <p className="text-gray-700 mb-6">{scenario.description}</p>
            
            <div className="space-y-3">
              {scenario.options.map((option, index) => (
                <button
                  key={index}
                  onClick={() => {
                    option.action();
                    if (currentScenario < scenarios.length - 1) {
                      setTimeout(() => setCurrentScenario(prev => prev + 1), 1000);
                    } else {
                      setTimeout(() => setGameState('results'), 1000);
                    }
                  }}
                  className="w-full p-4 text-left bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-200 transition-colors"
                >
                  {option.text}
                </button>
              ))}
            </div>
          </div>
          
          {/* Side Panel */}
          <div className="space-y-4">
            {/* Character Info */}
            <div className="bg-white rounded-lg shadow-lg p-4">
              <h3 className="font-bold mb-2 flex items-center">
                <User className="w-4 h-4 mr-2" />
                {avatar.name}
              </h3>
              <p className="text-sm text-gray-600">Background: {avatar.background}</p>
            </div>
            
            {/* Relationships */}
            <div className="bg-white rounded-lg shadow-lg p-4">
              <h3 className="font-bold mb-2 flex items-center">
                <Heart className="w-4 h-4 mr-2" />
                Relationships
              </h3>
              {Object.entries(relationships).map(([name, level]) => (
                <div key={name} className="flex justify-between items-center mb-1">
                  <span className="capitalize">{name}</span>
                  <div className="flex">
                    {[...Array(5)].map((_, i) => (
                      <Star
                        key={i}
                        className={`w-3 h-3 ${i < Math.abs(level) ? (level > 0 ? 'text-yellow-500' : 'text-red-500') : 'text-gray-300'}`}
                        fill="currentColor"
                      />
                    ))}
                  </div>
                </div>
              ))}
            </div>
            
            {/* Progress */}
            <div className="bg-white rounded-lg shadow-lg p-4">
              <h3 className="font-bold mb-2 flex items-center">
                <Trophy className="w-4 h-4 mr-2" />
                Progress
              </h3>
              <div className="w-full bg-gray-200 rounded-full h-2">
                <div
                  className="bg-blue-500 h-2 rounded-full transition-all"
                  style={{ width: `${((currentScenario + 1) / scenarios.length) * 100}%` }}
                ></div>
              </div>
              <p className="text-sm text-gray-600 mt-1">
                Scenario {currentScenario + 1} of {scenarios.length}
              </p>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const renderResults = () => {
    const getPersonalityInsight = (score) => {
      if (score >= 3) return 'Very High';
      if (score >= 1) return 'High';
      if (score >= -1) return 'Moderate';
      if (score >= -3) return 'Low';
      return 'Very Low';
    };

    const getPersonalityDescription = () => {
      const traits = [];
      if (behaviorData.introversion > 0) traits.push('socially outgoing');
      else if (behaviorData.introversion < -2) traits.push('prefers solitude');
      
      if (behaviorData.empathy > 1) traits.push('highly empathetic');
      if (behaviorData.cooperation > 1) traits.push('team-oriented');
      if (behaviorData.riskTolerance > 1) traits.push('risk-taking');
      if (behaviorData.problemSolving > 1) traits.push('analytical thinker');
      else if (behaviorData.problemSolving < -1) traits.push('creative problem solver');
      
      return traits.length > 0 ? traits.join(', ') : 'balanced in approach';
    };

    return (
      <div className="max-w-3xl mx-auto p-6 bg-white rounded-lg shadow-lg">
        <h2 className="text-3xl font-bold mb-6 text-center">Your Personality Profile</h2>
        
        <div className="mb-8 p-4 bg-blue-50 rounded-lg">
          <h3 className="text-lg font-semibold mb-2">Overall Assessment</h3>
          <p className="text-gray-700">
            Based on your choices, you appear to be {getPersonalityDescription()}.
          </p>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          {[
            { label: 'Social Orientation', value: behaviorData.introversion, desc: 'How you prefer to interact with others' },
            { label: 'Empathy Level', value: behaviorData.empathy, desc: 'How much you consider others\' feelings' },
            { label: 'Risk Tolerance', value: behaviorData.riskTolerance, desc: 'Your comfort with uncertainty' },
            { label: 'Problem Solving', value: behaviorData.problemSolving, desc: 'Analytical vs Creative approach' },
            { label: 'Cooperation', value: behaviorData.cooperation, desc: 'Preference for teamwork vs independence' }
          ].map((trait, index) => (
            <div key={index} className="p-4 border rounded-lg">
              <h4 className="font-semibold">{trait.label}</h4>
              <p className="text-sm text-gray-600 mb-2">{trait.desc}</p>
              <div className="flex items-center gap-2">
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div
                    className={`h-2 rounded-full ${trait.value > 0 ? 'bg-green-500' : 'bg-orange-500'}`}
                    style={{ width: `${Math.abs(trait.value) * 20}%` }}
                  ></div>
                </div>
                <span className="text-sm font-medium">{getPersonalityInsight(trait.value)}</span>
              </div>
            </div>
          ))}
        </div>
        
        <div className="text-center">
          <button
            onClick={() => {
              setGameState('avatar-creation');
              setCurrentScenario(0);
              setBehaviorData({
                introversion: 0,
                riskTolerance: 0,
                empathy: 0,
                problemSolving: 0,
                cooperation: 0,
                timeSpent: {},
                choices: []
              });
            }}
            className="bg-blue-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-600"
          >
            Play Again
          </button>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-100 to-purple-100 py-8">
      {gameState === 'avatar-creation' && renderAvatarCreation()}
      {gameState === 'game' && renderGame()}
      {gameState === 'results' && renderResults()}
    </div>
  );
};

export default PersonalityGame;
